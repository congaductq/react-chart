{"version":3,"sources":["../../../src/lib/series/OHLCSeries.js"],"names":["OHLCSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","yAccessor","xAccessor","xScale","yScale","chartConfig","plotData","barData","getOHLCBars","clip","getAxisCanvas","className","strokeWidth","bars","map","d","idx","stroke","openX1","openY","openX2","x","y1","y2","closeX1","closeY","closeX2","Component","propTypes","PropTypes","string","classNames","oneOfType","func","isRequired","bool","defaultProps","open","high","low","close","absoluteChange","wickNest","key","entries","lineWidth","forEach","outer","values","strokeStyle","beginPath","moveTo","lineTo","classNamesProp","strokeProp","strokeFunc","classNameFunc","width","length","barWidth","Math","max","round","min","filter","ohlc"],"mappings":"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","file":"OHLCSeries.js","sourcesContent":["\r\n\r\nimport { nest } from \"d3-collection\";\r\nimport React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\nimport GenericChartComponent from \"../GenericChartComponent\";\r\nimport { getAxisCanvas } from \"../GenericComponent\";\r\n\r\nimport { isDefined, functor } from \"../utils\";\r\n\r\nclass OHLCSeries extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\t\tthis.renderSVG = this.renderSVG.bind(this);\r\n\t\tthis.drawOnCanvas = this.drawOnCanvas.bind(this);\r\n\t}\r\n\tdrawOnCanvas(ctx, moreProps) {\r\n\t\tconst { yAccessor } = this.props;\r\n\t\tconst { xAccessor } = moreProps;\r\n\t\tconst { xScale, chartConfig: { yScale }, plotData } = moreProps;\r\n\r\n\t\tconst barData = getOHLCBars(this.props, xAccessor, yAccessor, xScale, yScale, plotData);\r\n\t\tdrawOnCanvas(ctx, barData);\r\n\t}\r\n\trender() {\r\n\t\tconst { clip } = this.props;\r\n\r\n\t\treturn <GenericChartComponent\r\n\t\t\tsvgDraw={this.renderSVG}\r\n\t\t\tcanvasToDraw={getAxisCanvas}\r\n\t\t\tcanvasDraw={this.drawOnCanvas}\r\n\t\t\tclip={clip}\r\n\t\t\tdrawOn={[\"pan\"]}\r\n\t\t/>;\r\n\t}\r\n\trenderSVG(moreProps) {\r\n\t\tconst { className, yAccessor } = this.props;\r\n\t\tconst { xAccessor } = moreProps;\r\n\t\tconst { xScale, chartConfig: { yScale }, plotData } = moreProps;\r\n\r\n\r\n\t\tconst barData = getOHLCBars(this.props, xAccessor, yAccessor, xScale, yScale, plotData);\r\n\r\n\t\tconst { strokeWidth, bars } = barData;\r\n\r\n\t\treturn <g className={className}>\r\n\t\t\t{bars.map((d, idx) => <path key={idx}\r\n\t\t\t\tclassName={d.className} stroke={d.stroke} strokeWidth={strokeWidth}\r\n\t\t\t\td={`M${d.openX1} ${d.openY} L${d.openX2} ${d.openY} M${d.x} ${d.y1} L${d.x} ${d.y2} M${d.closeX1} ${d.closeY} L${d.closeX2} ${d.closeY}`}/>)}\r\n\t\t</g>;\r\n\t}\r\n}\r\n\r\nOHLCSeries.propTypes = {\r\n\tclassName: PropTypes.string,\r\n\tclassNames: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]).isRequired,\r\n\tstroke: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]).isRequired,\r\n\tyAccessor: PropTypes.func.isRequired,\r\n\tclip: PropTypes.bool.isRequired,\r\n};\r\n\r\nOHLCSeries.defaultProps = {\r\n\tclassName: \"react-stockcharts-ohlc\",\r\n\tyAccessor: (d) => ({ open: d.open, high: d.high, low: d.low, close: d.close }),\r\n\tclassNames: d => isDefined(d.absoluteChange) ? (d.absoluteChange > 0 ? \"up\" : \"down\") : \"firstbar\",\r\n\tstroke: d => isDefined(d.absoluteChange) ? (d.absoluteChange > 0 ? \"#6BA583\" : \"#FF0000\") : \"#000000\",\r\n\tclip: true,\r\n};\r\n\r\nfunction drawOnCanvas(ctx, barData) {\r\n\r\n\tconst { strokeWidth, bars } = barData;\r\n\r\n\tconst wickNest = nest()\r\n\t\t.key(d => d.stroke)\r\n\t\t.entries(bars);\r\n\r\n\tctx.lineWidth = strokeWidth;\r\n\r\n\twickNest.forEach(outer => {\r\n\t\tconst { key, values } = outer;\r\n\t\tctx.strokeStyle = key;\r\n\t\tvalues.forEach(d => {\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo(d.x, d.y1);\r\n\t\t\tctx.lineTo(d.x, d.y2);\r\n\r\n\t\t\tctx.moveTo(d.openX1, d.openY);\r\n\t\t\tctx.lineTo(d.openX2, d.openY);\r\n\r\n\t\t\tctx.moveTo(d.closeX1, d.closeY);\r\n\t\t\tctx.lineTo(d.closeX2, d.closeY);\r\n\r\n\t\t\tctx.stroke();\r\n\t\t});\r\n\t});\r\n}\r\n\r\nfunction getOHLCBars(props, xAccessor, yAccessor, xScale, yScale, plotData) {\r\n\tconst { classNames: classNamesProp, stroke: strokeProp } = props;\r\n\r\n\tconst strokeFunc = functor(strokeProp);\r\n\tconst classNameFunc = functor(classNamesProp);\r\n\r\n\tconst width = xScale(xAccessor(plotData[plotData.length - 1]))\r\n\t\t- xScale(xAccessor(plotData[0]));\r\n\r\n\tconst barWidth = Math.max(1, Math.round(width / (plotData.length - 1) / 2) - 1.5);\r\n\tconst strokeWidth = Math.min(barWidth, 6);\r\n\r\n\tconst bars = plotData\r\n\t\t.filter(d => isDefined(yAccessor(d).close))\r\n\t\t.map(d => {\r\n\t\t\tconst ohlc = yAccessor(d),\r\n\t\t\t\tx = Math.round(xScale(xAccessor(d))),\r\n\t\t\t\ty1 = yScale(ohlc.high),\r\n\t\t\t\ty2 = yScale(ohlc.low),\r\n\t\t\t\topenX1 = x - barWidth,\r\n\t\t\t\topenX2 = x + strokeWidth / 2,\r\n\t\t\t\topenY = yScale(ohlc.open),\r\n\t\t\t\tcloseX1 = x - strokeWidth / 2,\r\n\t\t\t\tcloseX2 = x + barWidth,\r\n\t\t\t\tcloseY = yScale(ohlc.close),\r\n\t\t\t\tclassName = classNameFunc(d),\r\n\t\t\t\tstroke = strokeFunc(d);\r\n\r\n\t\t\treturn { x, y1, y2, openX1, openX2, openY, closeX1, closeX2, closeY, stroke, className };\r\n\t\t});\r\n\treturn { barWidth, strokeWidth, bars };\r\n}\r\n\r\nexport default OHLCSeries;\r\n"]}