{"version":3,"sources":["../../../src/lib/scale/financeDiscontinuousScale.js"],"names":["financeDiscontinuousScale","MAX_LEVEL","levelDefinition","length","index","futureProvider","backingLinearScale","Error","scale","x","invert","inverted","Math","round","domain","arguments","range","rangeRound","clamp","interpolate","ticks","m","flexTicks","backingTicks","ticksMap","domainStart","domainEnd","start","max","ceil","abs","end","min","floor","desiredTickCount","i","ticksAtLevel","get","temp","slice","j","level","push","set","unsortedTicks","concat","map","d","sort","ascending","ticksSet","distance","remove","tickValues","values","parseInt","tickFormat","format","date","value","nice","copy"],"mappings":"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","file":"financeDiscontinuousScale.js","sourcesContent":["\r\n\r\nimport { set, map } from \"d3-collection\";\r\nimport { ascending } from \"d3-array\";\r\nimport { scaleLinear } from \"d3-scale\";\r\n\r\nimport { isDefined, isNotDefined, head, last } from \"../utils\";\r\nimport { levelDefinition } from \"./levels\";\r\n\r\nconst MAX_LEVEL = levelDefinition.length - 1;\r\n\r\nexport default function financeDiscontinuousScale(\r\n\tindex,\r\n\tfutureProvider,\r\n\tbackingLinearScale = scaleLinear()\r\n) {\r\n\r\n\tif (isNotDefined(index))\r\n\t\tthrow new Error(\"Use the discontinuousTimeScaleProvider to create financeDiscontinuousScale\");\r\n\r\n\tfunction scale(x) {\r\n\t\treturn backingLinearScale(x);\r\n\t}\r\n\tscale.invert = function(x) {\r\n\t\tconst inverted = backingLinearScale.invert(x);\r\n\t\treturn Math.round(inverted * 10000) / 10000;\r\n\t};\r\n\tscale.domain = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.domain();\r\n\t\tbackingLinearScale.domain(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.range = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.range();\r\n\t\tbackingLinearScale.range(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.rangeRound = function(x) {\r\n\t\treturn backingLinearScale.range(x);\r\n\t};\r\n\tscale.clamp = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.clamp();\r\n\t\tbackingLinearScale.clamp(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.interpolate = function(x) {\r\n\t\tif (!arguments.length) return backingLinearScale.interpolate();\r\n\t\tbackingLinearScale.interpolate(x);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.ticks = function(m, flexTicks) {\r\n\t\tconst backingTicks = backingLinearScale.ticks(m);\r\n\t\tconst ticksMap = map();\r\n\r\n\t\tconst [domainStart, domainEnd] = backingLinearScale.domain();\r\n\r\n\t\tconst start = Math.max(Math.ceil(domainStart), head(index).index) + Math.abs(head(index).index);\r\n\t\tconst end = Math.min(Math.floor(domainEnd), last(index).index) + Math.abs(head(index).index);\r\n\r\n\t\tif (Math.floor(domainEnd) > end) {\r\n\t\t\t// console.log(end, domainEnd, index);\r\n\t\t}\r\n\r\n\t\tconst desiredTickCount = Math.ceil((end - start) / (domainEnd - domainStart) * backingTicks.length);\r\n\r\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\r\n\t\t\tconst ticksAtLevel = ticksMap.get(i);\r\n\t\t\tconst temp = isNotDefined(ticksAtLevel)\r\n\t\t\t\t? []\r\n\t\t\t\t: ticksAtLevel.slice();\r\n\r\n\t\t\tfor (let j = start; j <= end; j++) {\r\n\t\t\t\tif (index[j].level === i) {\r\n\t\t\t\t\ttemp.push(index[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tticksMap.set(i, temp);\r\n\t\t}\r\n\r\n\t\tlet unsortedTicks = [];\r\n\t\tfor (let i = MAX_LEVEL; i >= 0; i--) {\r\n\t\t\tif ((ticksMap.get(i).length + unsortedTicks.length) > desiredTickCount * 1.5) break;\r\n\t\t\tunsortedTicks = unsortedTicks.concat(ticksMap.get(i).map(d => d.index));\r\n\t\t}\r\n\r\n\t\tconst ticks = unsortedTicks.sort(ascending);\r\n\r\n\t\t// console.log(backingTicks.length, desiredTickCount, ticks, ticksMap);\r\n\r\n\t\tif (!flexTicks && end - start > ticks.length) {\r\n\t\t\tconst ticksSet = set(ticks);\r\n\r\n\t\t\tconst d = Math.abs(head(index).index);\r\n\r\n\t\t\t// ignore ticks within this distance\r\n\t\t\tconst distance = Math.ceil(\r\n\t\t\t\t(backingTicks.length > 0\r\n\t\t\t\t\t? (last(backingTicks) - head(backingTicks)) / (backingTicks.length) / 4\r\n\t\t\t\t\t: 1) * 1.5);\r\n\r\n\t\t\tfor (let i = 0; i < ticks.length - 1; i++) {\r\n\t\t\t\tfor (let j = i + 1; j < ticks.length; j++) {\r\n\t\t\t\t\tif (ticks[j] - ticks[i] <= distance) {\r\n\t\t\t\t\t\tticksSet.remove(index[ticks[i] + d].level >= index[ticks[j] + d].level ? ticks[j] : ticks[i]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tconst tickValues = ticksSet.values().map(d => parseInt(d, 10));\r\n\r\n\t\t\t// console.log(ticks.length, tickValues, level);\r\n\t\t\t// console.log(ticks, tickValues, distance);\r\n\r\n\t\t\treturn tickValues;\r\n\t\t}\r\n\r\n\t\treturn ticks;\r\n\t};\r\n\tscale.tickFormat = function() {\r\n\t\treturn function(x) {\r\n\t\t\tconst d = Math.abs(head(index).index);\r\n\t\t\tconst { format, date } = index[Math.floor(x + d)];\r\n\t\t\treturn format(date);\r\n\t\t};\r\n\t};\r\n\tscale.value = function(x) {\r\n\t\tconst d = Math.abs(head(index).index);\r\n\t\tif (isDefined(index[Math.floor(x + d)])) {\r\n\t\t\tconst { date } = index[Math.floor(x + d)];\r\n\t\t\treturn date;\r\n\t\t}\r\n\t};\r\n\tscale.nice = function(m) {\r\n\t\tbackingLinearScale.nice(m);\r\n\t\treturn scale;\r\n\t};\r\n\tscale.index = function(x) {\r\n\t\tif (!arguments.length) return index;\r\n\t\tindex = x;\r\n\t\treturn scale;\r\n\t};\r\n\tscale.copy = function() {\r\n\t\treturn financeDiscontinuousScale(index, futureProvider, backingLinearScale.copy());\r\n\t};\r\n\treturn scale;\r\n}"]}