{"version":3,"sources":["../../../src/lib/series/CandlestickSeries.js"],"names":["CandlestickSeries","props","renderSVG","bind","drawOnCanvas","ctx","moreProps","className","wickClassName","candleClassName","xScale","yScale","chartConfig","plotData","xAccessor","candleData","getCandleData","getWicksSVG","getCandlesSVG","clip","getAxisCanvas","Component","propTypes","PropTypes","string","widthRatio","number","width","oneOfType","func","classNames","fill","stroke","wickStroke","yAccessor","bool","defaultProps","open","d","high","low","close","plotDataLengthBarWidth","candleStrokeWidth","opacity","wicks","map","each","idx","wick","x","y1","y2","y3","y4","candles","y","height","wickNest","key","entries","forEach","outer","values","strokeStyle","fillStyle","fillRect","candleNest","strokeKey","strokeValues","lineWidth","inner","strokeRect","wickStrokeProp","fillProp","strokeProp","widthFunctor","trueOffset","offset","Math","round","floor","i","length","ohlc","max","abs","push","direction"],"mappings":"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","file":"CandlestickSeries.js","sourcesContent":["\r\n\r\nimport { nest } from \"d3-collection\";\r\n\r\nimport React, { Component } from \"react\";\r\nimport PropTypes from \"prop-types\";\r\n\r\nimport GenericChartComponent from \"../GenericChartComponent\";\r\nimport { getAxisCanvas } from \"../GenericComponent\";\r\n\r\nimport {\r\n\thexToRGBA, isDefined, functor, plotDataLengthBarWidth, head\r\n} from \"../utils\";\r\n\r\nclass CandlestickSeries extends Component {\r\n\tconstructor(props) {\r\n\t\tsuper(props);\r\n\t\tthis.renderSVG = this.renderSVG.bind(this);\r\n\t\tthis.drawOnCanvas = this.drawOnCanvas.bind(this);\r\n\t}\r\n\tdrawOnCanvas(ctx, moreProps) {\r\n\t\tdrawOnCanvas(ctx, this.props, moreProps);\r\n\t}\r\n\trenderSVG(moreProps) {\r\n\t\tconst { className, wickClassName, candleClassName } = this.props;\r\n\t\tconst { xScale, chartConfig: { yScale }, plotData, xAccessor } = moreProps;\r\n\r\n\t\tconst candleData = getCandleData(this.props, xAccessor, xScale, yScale, plotData);\r\n\r\n\t\treturn <g className={className}>\r\n\t\t\t<g className={wickClassName} key=\"wicks\">\r\n\t\t\t\t{getWicksSVG(candleData)}\r\n\t\t\t</g>\r\n\t\t\t<g className={candleClassName} key=\"candles\">\r\n\t\t\t\t{getCandlesSVG(this.props, candleData)}\r\n\t\t\t</g>\r\n\t\t</g>;\r\n\t}\r\n\r\n\trender() {\r\n\t\tconst { clip } = this.props;\r\n\t\treturn <GenericChartComponent\r\n\t\t\tclip={clip}\r\n\t\t\tsvgDraw={this.renderSVG}\r\n\t\t\tcanvasDraw={this.drawOnCanvas}\r\n\t\t\tcanvasToDraw={getAxisCanvas}\r\n\t\t\tdrawOn={[\"pan\"]}\r\n\t\t/>;\r\n\t}\r\n}\r\n\r\nCandlestickSeries.propTypes = {\r\n\tclassName: PropTypes.string,\r\n\twickClassName: PropTypes.string,\r\n\tcandleClassName: PropTypes.string,\r\n\twidthRatio: PropTypes.number,\r\n\twidth: PropTypes.oneOfType([\r\n\t\tPropTypes.number,\r\n\t\tPropTypes.func\r\n\t]),\r\n\tclassNames: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]),\r\n\tfill: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]),\r\n\tstroke: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]),\r\n\twickStroke: PropTypes.oneOfType([\r\n\t\tPropTypes.func,\r\n\t\tPropTypes.string\r\n\t]),\r\n\tyAccessor: PropTypes.func,\r\n\tclip: PropTypes.bool,\r\n};\r\n\r\nCandlestickSeries.defaultProps = {\r\n\tclassName: \"react-stockcharts-candlestick\",\r\n\twickClassName: \"react-stockcharts-candlestick-wick\",\r\n\tcandleClassName: \"react-stockcharts-candlestick-candle\",\r\n\tyAccessor: d => ({ open: d.open, high: d.high, low: d.low, close: d.close }),\r\n\tclassNames: d => d.close > d.open ? \"up\" : \"down\",\r\n\twidth: plotDataLengthBarWidth,\r\n\twickStroke: \"#000000\",\r\n\t// wickStroke: d => d.close > d.open ? \"#6BA583\" : \"#FF0000\",\r\n\tfill: d => d.close > d.open ? \"#6BA583\" : \"#FF0000\",\r\n\t// stroke: d => d.close > d.open ? \"#6BA583\" : \"#FF0000\",\r\n\tstroke: \"#000000\",\r\n\tcandleStrokeWidth: 0.5,\r\n\t// stroke: \"none\",\r\n\twidthRatio: 0.8,\r\n\topacity: 0.5,\r\n\tclip: true,\r\n};\r\n\r\nfunction getWicksSVG(candleData) {\r\n\r\n\tconst wicks = candleData\r\n\t\t.map((each, idx) => {\r\n\t\t\tconst d = each.wick;\r\n\t\t\treturn <path key={idx}\r\n\t\t\t\tclassName={each.className}\r\n\t\t\t\tstroke={d.stroke}\r\n\t\t\t\td={`M${d.x},${d.y1} L${d.x},${d.y2} M${d.x},${d.y3} L${d.x},${d.y4}`} />;\r\n\t\t});\r\n\r\n\treturn wicks;\r\n}\r\n\r\nfunction getCandlesSVG(props, candleData) {\r\n\r\n\t/* eslint-disable react/prop-types */\r\n\tconst { opacity, candleStrokeWidth } = props;\r\n\t/* eslint-enable react/prop-types */\r\n\r\n\tconst candles = candleData.map((d, idx) => {\r\n\t\tif (d.width <= 1)\r\n\t\t\treturn (\r\n\t\t\t\t<line className={d.className} key={idx}\r\n\t\t\t\t\tx1={d.x} y1={d.y} x2={d.x} y2={d.y + d.height}\r\n\t\t\t\t\tstroke={d.fill} />\r\n\t\t\t);\r\n\t\telse if (d.height === 0)\r\n\t\t\treturn (\r\n\t\t\t\t<line key={idx}\r\n\t\t\t\t\tx1={d.x} y1={d.y} x2={d.x + d.width} y2={d.y + d.height}\r\n\t\t\t\t\tstroke={d.fill} />\r\n\t\t\t);\r\n\t\treturn (\r\n\t\t\t<rect key={idx} className={d.className}\r\n\t\t\t\tfillOpacity={opacity}\r\n\t\t\t\tx={d.x} y={d.y} width={d.width} height={d.height}\r\n\t\t\t\tfill={d.fill} stroke={d.stroke} strokeWidth={candleStrokeWidth} />\r\n\t\t);\r\n\t});\r\n\treturn candles;\r\n}\r\n\r\nfunction drawOnCanvas(ctx, props, moreProps) {\r\n\tconst { opacity, candleStrokeWidth } = props;\r\n\tconst { xScale, chartConfig: { yScale }, plotData, xAccessor } = moreProps;\r\n\r\n\t// const wickData = getWickData(props, xAccessor, xScale, yScale, plotData);\r\n\tconst candleData = getCandleData(props, xAccessor, xScale, yScale, plotData);\r\n\r\n\tconst wickNest = nest()\r\n\t\t.key(d => d.wick.stroke)\r\n\t\t.entries(candleData);\r\n\r\n\twickNest.forEach(outer => {\r\n\t\tconst { key, values } = outer;\r\n\t\tctx.strokeStyle = key;\r\n\t\tctx.fillStyle = key;\r\n\t\tvalues.forEach(each => {\r\n\t\t\t/*\r\n\t\t\tctx.moveTo(d.x, d.y1);\r\n\t\t\tctx.lineTo(d.x, d.y2);\r\n\r\n\t\t\tctx.beginPath();\r\n\t\t\tctx.moveTo(d.x, d.y3);\r\n\t\t\tctx.lineTo(d.x, d.y4);\r\n\t\t\tctx.stroke(); */\r\n\t\t\tconst d = each.wick;\r\n\r\n\t\t\tctx.fillRect(d.x - 0.5, d.y1, 1, d.y2 - d.y1);\r\n\t\t\tctx.fillRect(d.x - 0.5, d.y3, 1, d.y4 - d.y3);\r\n\t\t});\r\n\t});\r\n\r\n\t// const candleData = getCandleData(props, xAccessor, xScale, yScale, plotData);\r\n\r\n\tconst candleNest = nest()\r\n\t\t.key(d => d.stroke)\r\n\t\t.key(d => d.fill)\r\n\t\t.entries(candleData);\r\n\r\n\r\n\tcandleNest.forEach(outer => {\r\n\t\tconst { key: strokeKey, values: strokeValues } = outer;\r\n\t\tif (strokeKey !== \"none\") {\r\n\t\t\tctx.strokeStyle = strokeKey;\r\n\t\t\tctx.lineWidth = candleStrokeWidth;\r\n\t\t}\r\n\t\tstrokeValues.forEach(inner => {\r\n\t\t\tconst { key, values } = inner;\r\n\t\t\tconst fillStyle = head(values).width <= 1\r\n\t\t\t\t? key\r\n\t\t\t\t: hexToRGBA(key, opacity);\r\n\t\t\tctx.fillStyle = fillStyle;\r\n\r\n\t\t\tvalues.forEach(d => {\r\n\t\t\t\tif (d.width <= 1) {\r\n\t\t\t\t\t// <line className={d.className} key={idx} x1={d.x} y1={d.y} x2={d.x} y2={d.y + d.height}/>\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.moveTo(d.x, d.y);\r\n\t\t\t\t\tctx.lineTo(d.x, d.y + d.height);\r\n\t\t\t\t\tctx.stroke();\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tctx.fillRect(d.x - 0.5, d.y, 1, d.height);\r\n\t\t\t\t} else if (d.height === 0) {\r\n\t\t\t\t\t// <line key={idx} x1={d.x} y1={d.y} x2={d.x + d.width} y2={d.y + d.height} />\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.moveTo(d.x, d.y);\r\n\t\t\t\t\tctx.lineTo(d.x + d.width, d.y + d.height);\r\n\t\t\t\t\tctx.stroke();\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tctx.fillRect(d.x, d.y - 0.5, d.width, 1);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tctx.beginPath();\r\n\t\t\t\t\tctx.rect(d.x, d.y, d.width, d.height);\r\n\t\t\t\t\tctx.closePath();\r\n\t\t\t\t\tctx.fill();\r\n\t\t\t\t\tif (strokeKey !== \"none\") ctx.stroke();\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tctx.fillRect(d.x, d.y, d.width, d.height);\r\n\t\t\t\t\tif (strokeKey !== \"none\") ctx.strokeRect(d.x, d.y, d.width, d.height);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t});\r\n\t});\r\n}\r\n/*\r\nfunction getWickData(props, xAccessor, xScale, yScale, plotData) {\r\n\r\n\tconst { classNames: classNameProp, wickStroke: wickStrokeProp, yAccessor } = props;\r\n\tconst wickStroke = functor(wickStrokeProp);\r\n\tconst className = functor(classNameProp);\r\n\tconst wickData = plotData\r\n\t\t\t.filter(d => isDefined(yAccessor(d).close))\r\n\t\t\t.map(d => {\r\n\t\t\t\t// console.log(yAccessor);\r\n\t\t\t\tconst ohlc = yAccessor(d);\r\n\r\n\t\t\t\tconst x = Math.round(xScale(xAccessor(d))),\r\n\t\t\t\t\ty1 = yScale(ohlc.high),\r\n\t\t\t\t\ty2 = yScale(Math.max(ohlc.open, ohlc.close)),\r\n\t\t\t\t\ty3 = yScale(Math.min(ohlc.open, ohlc.close)),\r\n\t\t\t\t\ty4 = yScale(ohlc.low);\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tx,\r\n\t\t\t\t\ty1,\r\n\t\t\t\t\ty2,\r\n\t\t\t\t\ty3,\r\n\t\t\t\t\ty4,\r\n\t\t\t\t\tclassName: className(ohlc),\r\n\t\t\t\t\tdirection: (ohlc.close - ohlc.open),\r\n\t\t\t\t\tstroke: wickStroke(ohlc),\r\n\t\t\t\t};\r\n\t\t\t});\r\n\treturn wickData;\r\n}\r\n*/\r\n\r\nfunction getCandleData(props, xAccessor, xScale, yScale, plotData) {\r\n\r\n\tconst { wickStroke: wickStrokeProp } = props;\r\n\tconst wickStroke = functor(wickStrokeProp);\r\n\r\n\tconst { classNames, fill: fillProp, stroke: strokeProp, yAccessor } = props;\r\n\tconst className = functor(classNames);\r\n\r\n\tconst fill = functor(fillProp);\r\n\tconst stroke = functor(strokeProp);\r\n\r\n\tconst widthFunctor = functor(props.width);\r\n\tconst width = widthFunctor(props, {\r\n\t\txScale,\r\n\t\txAccessor,\r\n\t\tplotData\r\n\t});\r\n\r\n\t/*\r\n\tconst candleWidth = Math.round(width);\r\n\tconst offset = Math.round(candleWidth === 1 ? 0 : 0.5 * width);\r\n\t*/\r\n\tconst trueOffset = 0.5 * width;\r\n\tconst offset = trueOffset > 0.7\r\n\t\t? Math.round(trueOffset)\r\n\t\t: Math.floor(trueOffset);\r\n\r\n\t// eslint-disable-next-line prefer-const\r\n\tlet candles = [];\r\n\r\n\tfor (let i = 0; i < plotData.length; i++) {\r\n\t\tconst d = plotData[i];\r\n\t\tif (isDefined(yAccessor(d).close)) {\r\n\t\t\tconst x = Math.round(xScale(xAccessor(d)));\r\n\t\t\t// const x = Math.round(xScale(xAccessor(d)) - offset);\r\n\r\n\t\t\tconst ohlc = yAccessor(d);\r\n\t\t\tconst y = Math.round(yScale(Math.max(ohlc.open, ohlc.close)));\r\n\t\t\tconst height = Math.round(Math.abs(yScale(ohlc.open) - yScale(ohlc.close)));\r\n\r\n\t\t\tcandles.push({\r\n\t\t\t\t// type: \"line\"\r\n\t\t\t\tx: x - offset,\r\n\t\t\t\ty: y,\r\n\t\t\t\twick: {\r\n\t\t\t\t\tstroke: wickStroke(ohlc),\r\n\t\t\t\t\tx: x,\r\n\t\t\t\t\ty1: Math.round(yScale(ohlc.high)),\r\n\t\t\t\t\ty2: y,\r\n\t\t\t\t\ty3: y + height, // Math.round(yScale(Math.min(ohlc.open, ohlc.close))),\r\n\t\t\t\t\ty4: Math.round(yScale(ohlc.low)),\r\n\t\t\t\t},\r\n\t\t\t\theight: height,\r\n\t\t\t\twidth: offset * 2,\r\n\t\t\t\tclassName: className(ohlc),\r\n\t\t\t\tfill: fill(ohlc),\r\n\t\t\t\tstroke: stroke(ohlc),\r\n\t\t\t\tdirection: (ohlc.close - ohlc.open),\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\treturn candles;\r\n}\r\n\r\nexport default CandlestickSeries;\r\n"]}